@startuml WordMiner-v2-Complete-Architecture

' class App {
'     - articleService: ArticleService
'     - vocabularyService: VocabularyService
'     - mainWindow: MainWindow

'     __
'     + App()
'     + run(): void
'     - initializeServices(): void
'     - initializePresentation(): void
' }

package presentation {
    
    ' Main Window
    class MainWindow {
        - articleService: ArticleService
        - viewFactory: ViewFactory

        __
        + MainWindow(articleService: ArticleService, viewFactory: ViewFactory): void
        + display(): void
        - freshArticleList(): voidre
        - initializeUI(): void
        - onImportArticle(): void
        - onDeleteArticle(): void
        - onReadArticle(): void
        - onOpenArticleReport(): void
        - onOpenVocabulary(): void
    }
    
    ' Article Reader View
    class ArticleReaderView {
        - articleId: int
        - articleService: ArticleService
        - vocabularyService: VocabularyService

        __
        + ArticleReaderView(articleId, articleService, vocabularyService)
        + display()
        - initializeUI()
        - loadArticle()
        - displayArticleContent()
        - highlightWords(content: String)
        - onTextClicked(e: MouseEvent)
        - getWordAtPosition(pos: int): String
        - refreshDisplay()
    }
    
    
    ' Article Report View
    class ArticleReportView {
        - articleId: int
        - vocabularyService: VocabularyService
        - articleService: ArticleService
        __
        + ArticleReportView(articleId, vocabularyService, articleService)
        + display()
        - initializeUI()
    }
    
    ' Vocabulary View
    class LabeledWordsView {
        - vocabularyService: VocabularyService
        __
        + LabeledWordsView(vocabularyService)
        + display()
        - initializeUI()
        - refreshWordList()
        - updateStats()
    }
    
    ' View Factory
    class ViewFactory {
        - articleService: ArticleService
        - vocabularyService: VocabularyService
        __
        + ViewFactory(articleService: ArticleService, vocabularyService: VocabularyService)
        + createArticleReportView(articleId: int): ArticleReportView
        + createArticleReaderView(articleId: int): ArticleReaderView
        + createLabeledWordsView(): LabeledWordsView
    }

}

package domain {

    ' Entities
    class Article {
        - id: int
        - title: String
        - content: String
        - filePath: String
        - importDate: LocalDateTime
        - spec: ArticleSpec
        __
        ~ Article(id, title, content, filePath, importDate)
        ~ countWords(): int
        ~ countUniqueWords(): int
        ~ getWords(): List<String>
        ~ getUniqueWords(): Set<String>
        ~ getters()
    }

    class ArticleSpec {
        - totalWords: int
        - uniqueWords: int
        - knownWords: int
        - unknownWords: int
        - wordLevelDistribution: Map<String, Integer>
        __
        + ArticleVocabularyAnalysis(totalWords, uniqueWords, knownWords, unknownWords, wordLevelDistribution)
        + getKnownPercentage(): double
        + getters()
    }
    
    class Word {
        - word: String
        - levels: List<String>
        __
        ~ Word(word, levels)
        ~ hasLevel(level: String): boolean
        ~ getHighestLevel(): String
        ~ getters()
    }
    
    class UserWordStatus {
        - word: String
        - status: WordStatusEnum
        - markedDate: LocalDateTime
        __
        ~ UserWordStatus(word, status, markedDate)
        ~ updateStatsus(status: WordStatusEnum): boolean
        ~ isMastered(): boolean
        ~ getters()
    }
    
    enum WordStatusEnum {
        MASTERED
        NOT_MASTERED
    }
    
    ' Value Objects
    class WordInfo {
        - word: String
        - levels: List<String>
        - isInSystemDict: boolean
        - userStatus: WordStatusEnum
        __
        + WordInfo(word, levels, isInSystemDict, userStatus)
        + getUserStatus(): WordStatusEnum
        + isMarkedByUser(): boolean
        + isMastered(): boolean
        + isInSystemDict(): boolean
        + getLevels(): List<String>
    }
    
    ' class VocabularyStats {
    '     - totalSystemWords: int
    '     - totalUserMarkedWords: int
    '     - masteredWords: int
    '     - notMasteredWords: int
    '     __
    '     + VocabularyStats(totalSystemWords, totalUserMarkedWords, masteredWords, notMasteredWords)
    '     + getters()
    ' }
    
    
    ' Repositories
    class ArticleRepository {
        - articles: Map<int, Article>
        - dbLoader: DBLoader
        - dbSaver: DBSaver
        - fileLoader: FileLoader
        - mapper: ArticleDataMapper
        __
        ~ ArticleRepository(dbLoader, dbSaver, fileLoader, mapper)
        ~ getAllArticles(): List<Article>
        ~ findById(id: int): Article
        ~ importArticle(filePath: Path): boolean
        ~ delete(id: int): boolean
        ~ count(): int
    }
    
    class DictionaryRepository {
        - dbLoader: DBLoader
        - mapper: WordDataMapper
        - wordCache: Map<String, Word>
        __
        ~ DictionaryRepository(dbLoader, mapper)
        ~ findWord(word: String): Word
        ~ count(): int
        - loadAllWords()
    }
    
    class UserWordRepository {
        - dbLoader: DBLoader
        - dbSaver: DBSaver
        - mapper: Mapper
        - userWordCache: Map<String, UserWordStatus>
        __
        ~ UserWordRepository(dbLoader, dbSaver, mapper)
        ~ getUserWordStatus(word: String): UserWordStatus
        ~ updateWordStatus(word: String, status: WordStatusEnum): boolean
        ~ getAllUserWords(): List<UserWordStatus>
        ~ getAllMasteredWords(): List<UserWordStatus>
        ~ getAllNotMasteredWords(): List<UserWordStatus>
        ~ count(): int
        - loadAllUserWords()
    }
    
    ' Services
    class VocabularyService {
        - dictionaryRepo: DictionaryRepository
        - userWordRepo: UserWordRepository
        __
        + VocabularyService(dictionaryRepo, userWordRepo)
        + getWordInfo(word: String): WordInfo
        + markWord(word: String, status: WordStatusEnum): boolean
        + getVocabularyStats(): VocabularyStats
        + getAllUserWords(): List<UserWordStatus>
        + getMasteredWords(): List<UserWordStatus>
        + getNotMasteredWords(): List<UserWordStatus>
        - extractWords(text: String): Set<String>
    }

    class ArticleService {
        - articleRepo: ArticleRepository
        - dictionaryRepo: DictionaryRepository
        - userWordRepo: UserWordRepository
        __
        + ArticleService(articleRepo)
        + getAllArticles(): List<Article>
        + getArticleById(id: int): Article
        + importArticle(filePath: Path): boolean
        + deleteArticle(id: int): boolean
        + getArticleSpec(id: int): String
        + getArticleReport(id: int): String
        + countArticles(): int
    }
    
    ' class ArticleManager {
    '     - repository: ArticleRepository
    '     __
    '     + ArticleManager(repository)
    '     + getRepository(): ArticleRepository
    ' }
    
    ' Mappers
    interface Mapper {
        + toEntity(dto): Object
        + toDTO(entity): Object
    }
     
    class ArticleDataMapper {
        + toEntity(dto: DBArticleDTO): Article
        + toDTO(entity: Article): DBArticleDTO
    }
    
    class WordDataMapper {
        + toEntity(dto: DBWordDTO): Word
    }
    
    class UserWordStatusMapper {
        + toEntity(dto: DBUserWordStatusDTO): UserWordStatus
        + toDTO(entity: UserWordStatus): DBUserWordStatusDTO
    }

    Article --> ArticleSpec
    
    ArticleService --> ArticleRepository
    ArticleService --> DictionaryRepository
    ArticleService --> UserWordRepository

    VocabularyService --> DictionaryRepository
    VocabularyService --> UserWordRepository
    VocabularyService ..> WordInfo
    

    ArticleRepository -->"*" Article
    ArticleRepository --> Mapper

    DictionaryRepository --> Mapper
    DictionaryRepository -->"*" Word

    ArticleDataMapper ..|> Mapper
    WordDataMapper ..|> Mapper
    UserWordStatusMapper ..|> Mapper

    UserWordRepository -->"*" UserWordStatus
    UserWordRepository --> Mapper

    UserWordStatus --> WordStatusEnum

}

package datasource {
    
    ' DTOs
    class ArticleDTO {
        + id: int
        + title: String
        + content: String
        + filePath: String
        + importDate: String
        + totalWords: int
        + uniqueWords: int
        + knownWords: int
        + unknownWords: int
        + wordLevelDistribution: String
        __
        + ArticleDTO(id, title, content, filePath, importDate)
        + getters/setters()
    }
    
    class WordDTO {
        + word: String
        + levels: String
        __
        + WordDTO(word, levels)
        + getters/setters()
    }
    
    class UserWordStatusDTO {
        + word: String
        + status: String
        + markedDate: String
        __
        + UserWordStatusDTO(word, status, markedDate)
        + getters/setters()
    }
    

    ' Interfaces
    interface DBLoader {
        + hasNext(): boolean
        + next(): Object
    }
    
    interface DBSaver {
        + save(dto: Object): boolean
    }

    interface FileLoader {
        + loadFromFile(filePath: Path): Object
    }

    ' Implementations
    class DBArticleLoader {
        + hasNext(): boolean
        + next(): DBArticleDTO
    }

    class DBArticleSaver {
        + save(dto: DBArticleDTO): boolean
    }

    class DBDictionaryLoader {
        + hasNext(): boolean
        + next(): DBWordDTO
    }


    class DBUserWordLoader {
        + hasNext(): boolean
        + next(): DBUserWordStatusDTO
    }

    class DBUserWordSaver {
        + save(dto: DBUserWordStatusDTO): boolean
    }

    class FileArticleLoader {
        + loadFromFile(filePath: Path): DBArticleDTO
    }

    class FileDictionaryLoader {
        + loadDictionaryFromFiles(directoryPath: String): List<DBWordDTO>
    }


    ' class SQLiteDataSource {
    '     - {static} instance: SQLiteDataSource
    '     - connection: Connection
    '     - DB_URL: String
    '     __
    '     - SQLiteDataSource()
    '     + {static} getInstance(): SQLiteDataSource
    '     + getConnection(): Connection
    '     - initializeDatabase()
    '     - createTables()
    ' }
    
    ' class SQLiteArticleDAO {
    '     - dataSource: SQLiteDataSource
    '     __
    '     + SQLiteArticleDAO(dataSource)
    '     + loadAll(): List<DBArticleDTO>
    '     + loadById(id: int): DBArticleDTO
    '     + save(dto: DBArticleDTO): boolean
    '     + delete(id: int): boolean
    ' }
    
    ' class SQLiteDictionaryDAO {
    '     - dataSource: SQLiteDataSource
    '     __
    '     + SQLiteDictionaryDAO(dataSource)
    '     + loadAll(): List<DBWordDTO>
    '     + count(): int
    '     + saveWords(words: List<DBWordDTO>): boolean
    ' }
    
    ' class SQLiteUserWordDAO {
    '     - dataSource: SQLiteDataSource
    '     __
    '     + SQLiteUserWordDAO(dataSource)
    '     + loadAll(): List<DBUserWordStatusDTO>
    '     + loadByWord(word: String): DBUserWordStatusDTO
    '     + save(dto: DBUserWordStatusDTO): boolean
    '     + delete(word: String): boolean
    ' }
    
    ' class LocalFileLoader {
    '     + loadFromFile(filePath: Path): DBArticleDTO
    '     - readFileContent(filePath: Path): String
    '     - extractTitle(filePath: Path): String
    ' }
    
    ' class SystemDictionaryFileLoader {
    '     + loadDictionaryFromFiles(directoryPath: String): List<DBWordDTO>
    '     - parseDictionaryFile(filePath: Path): List<DBWordDTO>
    ' }
    
    ' class MigrationManager {
    '     - dbDictionaryLoader: DBDictionaryLoader
    '     - dbDictionarySaver: DBDictionarySaver
    '     - fileLoader: SystemDictionaryFileLoader
    '     - DICT_DATA_PATH: String
    '     __
    '     + MigrationManager(dbDictionaryLoader, dbDictionarySaver, fileLoader)
    '     + runMigrations()
    '     - needsMigration(): boolean
    '     - loadSystemDictionary()
    ' }

    DBArticleLoader ..|> DBLoader
    DBArticleSaver ..|> DBSaver
    DBDictionaryLoader ..|> DBLoader
    DBUserWordLoader ..|> DBLoader
    DBUserWordSaver ..|> DBSaver

    DBArticleLoader ..> ArticleDTO
    DBArticleSaver ..> ArticleDTO
    DBDictionaryLoader ..> WordDTO
    DBUserWordLoader ..> UserWordStatusDTO
    DBUserWordSaver ..> UserWordStatusDTO
    FileArticleLoader ..|> FileLoader
    FileArticleLoader ..> ArticleDTO
    FileDictionaryLoader ..|> FileLoader
    FileDictionaryLoader ..> WordDTO
}

' Presentation -> Domain relationships
MainWindow --> ArticleService
MainWindow --> ViewFactory

ViewFactory ..> ArticleReportView
ViewFactory ..> ArticleReaderView
ViewFactory ..> LabeledWordsView

ViewFactory --> ArticleService
ViewFactory --> VocabularyService

ArticleReaderView --> ArticleService
ArticleReaderView --> VocabularyService
ArticleReaderView ..> WordInfo
ArticleReportView ..> Article


' WordDetailView --> VocabularyService

ArticleReportView --> ArticleService
ArticleReportView --> VocabularyService

LabeledWordsView --> VocabularyService


' Domain -> Datasource relationships
ArticleRepository --> DBLoader
ArticleRepository --> DBSaver
ArticleRepository --> FileLoader
ArticleRepository ..> ArticleDTO

DictionaryRepository --> DBLoader
DictionaryRepository ..> WordDTO

UserWordRepository --> DBLoader
UserWordRepository --> DBSaver
UserWordRepository ..> UserWordStatusDTO

' Domain layer relationships
' ArticleRepository --> DBArticleLoader
' ArticleRepository --> DBArticleSaver
' ArticleRepository --> FileArticleLoader
' ArticleRepository --> ArticleDataMapper
' ArticleRepository ..> Article : manages

' DictionaryRepository --> DBDictionaryLoader
' DictionaryRepository --> WordDataMapper
' DictionaryRepository ..> Word : manages

' UserWordRepository --> DBUserWordLoader
' UserWordRepository --> DBUserWordSaver
' UserWordRepository --> UserWordStatusMapper
' UserWordRepository ..> UserWordStatus : manages

' VocabularyService --> DictionaryRepository
' VocabularyService --> UserWordRepository
' VocabularyService ..> WordInfo : creates
' VocabularyService ..> VocabularyStats : creates
' VocabularyService ..> ArticleVocabularyAnalysis : creates

' ArticleManager --> ArticleRepository

' UserWordStatus --> WordStatusEnum

' Domain -> DataSource relationships
' ArticleDataMapper ..> DBArticleDTO
' ArticleDataMapper ..> Article

' WordDataMapper ..> DBWordDTO
' WordDataMapper ..> Word

' UserWordStatusMapper ..> DBUserWordStatusDTO
' UserWordStatusMapper ..> UserWordStatus

' DataSource layer relationships
' SQLiteArticleDAO ..|> DBArticleLoader
' SQLiteArticleDAO ..|> DBArticleSaver
' SQLiteArticleDAO --> SQLiteDataSource
' SQLiteArticleDAO ..> DBArticleDTO

' SQLiteDictionaryDAO ..|> DBDictionaryLoader
' SQLiteDictionaryDAO ..|> DBDictionarySaver
' SQLiteDictionaryDAO --> SQLiteDataSource
' SQLiteDictionaryDAO ..> DBWordDTO

' SQLiteUserWordDAO ..|> DBUserWordLoader
' SQLiteUserWordDAO ..|> DBUserWordSaver
' SQLiteUserWordDAO --> SQLiteDataSource
' SQLiteUserWordDAO ..> DBUserWordStatusDTO

' LocalFileLoader ..|> FileArticleLoader
' LocalFileLoader ..> DBArticleDTO

' MigrationManager --> DBDictionaryLoader
' MigrationManager --> DBDictionarySaver
' MigrationManager --> SystemDictionaryFileLoader

' SystemDictionaryFileLoader ..> DBWordDTO


@enduml